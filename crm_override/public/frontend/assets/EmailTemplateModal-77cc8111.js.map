{"version":3,"file":"EmailTemplateModal-77cc8111.js","sources":["../../../../frontend/src/components/Modals/EmailTemplateModal.vue"],"sourcesContent":["<template>\n  <Dialog\n    v-model=\"show\"\n    :options=\"{\n      title: editMode ? __(emailTemplate.name) : __('Create Email Template'),\n      size: 'xl',\n      actions: [\n        {\n          label: editMode ? __('Update') : __('Create'),\n          variant: 'solid',\n          onClick: () => (editMode ? updateEmailTemplate() : callInsertDoc()),\n        },\n      ],\n    }\"\n  >\n    <template #body-content>\n      <div class=\"flex flex-col gap-4\">\n        <div class=\"flex sm:flex-row flex-col gap-4\">\n          <div class=\"flex-1\">\n            <div class=\"mb-1.5 text-sm text-gray-600\">\n              {{ __('Name') }}\n              <span class=\"text-red-500\">*</span>\n            </div>\n            <TextInput\n              ref=\"nameRef\"\n              variant=\"outline\"\n              v-model=\"_emailTemplate.name\"\n              :placeholder=\"__('Payment Reminder')\"\n            />\n          </div>\n          <div class=\"flex-1\">\n            <div class=\"mb-1.5 text-sm text-gray-600\">{{ __('Doctype') }}</div>\n            <Select\n              variant=\"outline\"\n              v-model=\"_emailTemplate.reference_doctype\"\n              :options=\"['CRM Deal', 'CRM Lead']\"\n              :placeholder=\"__('CRM Deal')\"\n            />\n          </div>\n        </div>\n        <div>\n          <div class=\"mb-1.5 text-sm text-gray-600\">\n            {{ __('Subject') }}\n            <span class=\"text-red-500\">*</span>\n          </div>\n          <TextInput\n            ref=\"subjectRef\"\n            variant=\"outline\"\n            v-model=\"_emailTemplate.subject\"\n            :placeholder=\"__('Payment Reminder from Frappé - (#{{ name }})')\"\n          />\n        </div>\n        <div>\n          <div class=\"mb-1.5 text-sm text-gray-600\">\n            {{ __('Content') }}\n            <span class=\"text-red-500\">*</span>\n          </div>\n          <FormControl\n            v-if=\"_emailTemplate.use_html\"\n            type=\"textarea\"\n            variant=\"outline\"\n            ref=\"content\"\n            :rows=\"10\"\n            v-model=\"_emailTemplate.response_html\"\n            :placeholder=\"\n              __(\n                '<p>Dear {{ lead_name }},</p>\\n\\n<p>This is a reminder for the payment of {{ grand_total }}.</p>\\n\\n<p>Thanks,</p>\\n<p>Frappé</p>'\n              )\n            \"\n          />\n          <TextEditor\n            v-else\n            variant=\"outline\"\n            ref=\"content\"\n            editor-class=\"!prose-sm overflow-auto min-h-[180px] max-h-80 py-1.5 px-2 rounded border border-gray-300 bg-white hover:border-gray-400 hover:shadow-sm focus:bg-white focus:border-gray-500 focus:shadow-sm focus:ring-0 focus-visible:ring-2 focus-visible:ring-gray-400 text-gray-800 transition-colors\"\n            :bubbleMenu=\"true\"\n            :content=\"_emailTemplate.response\"\n            @change=\"(val) => (_emailTemplate.response = val)\"\n            :placeholder=\"\n              __(\n                'Dear {{ lead_name }}, \\n\\nThis is a reminder for the payment of {{ grand_total }}. \\n\\nThanks, \\nFrappé'\n              )\n            \"\n          />\n        </div>\n        <div>\n          <Checkbox v-model=\"_emailTemplate.enabled\" :label=\"__('Enabled')\" />\n        </div>\n        <div>\n          <Checkbox v-model=\"_emailTemplate.use_html\" :label=\"__('Use HTML')\" />\n        </div>\n        <ErrorMessage :message=\"__(errorMessage)\" />\n      </div>\n    </template>\n  </Dialog>\n</template>\n\n<script setup>\nimport { capture } from '@/telemetry'\nimport { Checkbox, Select, TextEditor, call } from 'frappe-ui'\nimport { ref, nextTick, watch } from 'vue'\n\nconst props = defineProps({\n  emailTemplate: {\n    type: Object,\n    default: {},\n  },\n})\n\nconst show = defineModel()\nconst emailTemplates = defineModel('reloadEmailTemplates')\nconst errorMessage = ref('')\n\nconst emit = defineEmits(['after'])\n\nconst subjectRef = ref(null)\nconst nameRef = ref(null)\nconst editMode = ref(false)\nlet _emailTemplate = ref({})\n\nasync function updateEmailTemplate() {\n  if (!validate()) return\n  const old = { ...props.emailTemplate }\n  const newEmailTemplate = { ..._emailTemplate.value }\n\n  const nameChanged = old.name !== newEmailTemplate.name\n  delete old.name\n  delete newEmailTemplate.name\n\n  const otherFieldChanged =\n    JSON.stringify(old) !== JSON.stringify(newEmailTemplate)\n  const values = newEmailTemplate\n\n  if (!nameChanged && !otherFieldChanged) {\n    show.value = false\n    return\n  }\n\n  let name\n  if (nameChanged) {\n    name = await callRenameDoc()\n  }\n  if (otherFieldChanged) {\n    name = await callSetValue(values)\n  }\n  handleEmailTemplateUpdate({ name })\n}\n\nasync function callRenameDoc() {\n  const d = await call('frappe.client.rename_doc', {\n    doctype: 'Email Template',\n    old_name: props.emailTemplate.name,\n    new_name: _emailTemplate.value.name,\n  })\n  return d\n}\n\nasync function callSetValue(values) {\n  const d = await call('frappe.client.set_value', {\n    doctype: 'Email Template',\n    name: _emailTemplate.value.name,\n    fieldname: values,\n  })\n  return d.name\n}\n\nasync function callInsertDoc() {\n  if (!validate()) return\n  const doc = await call('frappe.client.insert', {\n    doc: {\n      doctype: 'Email Template',\n      ..._emailTemplate.value,\n    },\n  })\n  if (doc.name) {\n    capture('email_template_created', { doctype: doc.reference_doctype })\n    handleEmailTemplateUpdate(doc)\n  }\n}\n\nfunction handleEmailTemplateUpdate(doc) {\n  emailTemplates.value?.reload()\n  show.value = false\n}\n\nfunction validate() {\n  if (!_emailTemplate.value.name) {\n    errorMessage.value = 'Name is required'\n    return false\n  }\n  if (!_emailTemplate.value.subject) {\n    errorMessage.value = 'Subject is required'\n    return false\n  }\n  if (\n    !_emailTemplate.value.response ||\n    _emailTemplate.value.response === '<p></p>'\n  ) {\n    errorMessage.value = 'Content is required'\n    return false\n  }\n  return true\n}\n\nwatch(\n  () => show.value,\n  (value) => {\n    if (!value) return\n    editMode.value = false\n    errorMessage.value = ''\n    nextTick(() => {\n      if (_emailTemplate.value.name) {\n        subjectRef.value.el.focus()\n      } else {\n        nameRef.value.el.focus()\n      }\n      _emailTemplate.value = { ...props.emailTemplate }\n      if (_emailTemplate.value.name) {\n        editMode.value = true\n      }\n    })\n  }\n)\n</script>\n"],"names":["props","__props","show","_useModel","emailTemplates","errorMessage","ref","subjectRef","nameRef","editMode","_emailTemplate","updateEmailTemplate","validate","old","newEmailTemplate","nameChanged","otherFieldChanged","values","callRenameDoc","callSetValue","handleEmailTemplateUpdate","call","callInsertDoc","doc","capture","_a","watch","value","nextTick"],"mappings":"guBAsGA,MAAMA,EAAQC,EAORC,EAAOC,gBAAY,EACnBC,EAAiBD,IAAY,sBAAsB,EACnDE,EAAeC,EAAI,EAAE,EAIrBC,EAAaD,EAAI,IAAI,EACrBE,EAAUF,EAAI,IAAI,EAClBG,EAAWH,EAAI,EAAK,EAC1B,IAAII,EAAiBJ,EAAI,EAAE,EAE3B,eAAeK,GAAsB,CACnC,GAAI,CAACC,EAAQ,EAAI,OACjB,MAAMC,EAAM,CAAE,GAAGb,EAAM,aAAe,EAChCc,EAAmB,CAAE,GAAGJ,EAAe,KAAO,EAE9CK,EAAcF,EAAI,OAASC,EAAiB,KAClD,OAAOD,EAAI,KACX,OAAOC,EAAiB,KAExB,MAAME,EACJ,KAAK,UAAUH,CAAG,IAAM,KAAK,UAAUC,CAAgB,EACnDG,EAASH,EAEf,GAAI,CAACC,GAAe,CAACC,EAAmB,CACtCd,EAAK,MAAQ,GACb,MACD,CAGGa,GACK,MAAMG,EAAe,EAE1BF,GACK,MAAMG,EAAaF,CAAM,EAElCG,EAAkC,CACpC,CAEA,eAAeF,GAAgB,CAM7B,OALU,MAAMG,EAAK,2BAA4B,CAC/C,QAAS,iBACT,SAAUrB,EAAM,cAAc,KAC9B,SAAUU,EAAe,MAAM,IACnC,CAAG,CAEH,CAEA,eAAeS,EAAaF,EAAQ,CAMlC,OALU,MAAMI,EAAK,0BAA2B,CAC9C,QAAS,iBACT,KAAMX,EAAe,MAAM,KAC3B,UAAWO,CACf,CAAG,GACQ,IACX,CAEA,eAAeK,GAAgB,CAC7B,GAAI,CAACV,EAAQ,EAAI,OACjB,MAAMW,EAAM,MAAMF,EAAK,uBAAwB,CAC7C,IAAK,CACH,QAAS,iBACT,GAAGX,EAAe,KACnB,CACL,CAAG,EACGa,EAAI,OACNC,EAAQ,yBAA0B,CAAE,QAASD,EAAI,iBAAiB,CAAE,EACpEH,EAA6B,EAEjC,CAEA,SAASA,EAA0BG,EAAK,QACtCE,EAAArB,EAAe,QAAf,MAAAqB,EAAsB,SACtBvB,EAAK,MAAQ,EACf,CAEA,SAASU,GAAW,CAClB,OAAKF,EAAe,MAAM,KAIrBA,EAAe,MAAM,QAKxB,CAACA,EAAe,MAAM,UACtBA,EAAe,MAAM,WAAa,WAElCL,EAAa,MAAQ,sBACd,IAEF,IAVLA,EAAa,MAAQ,sBACd,KALPA,EAAa,MAAQ,mBACd,GAcX,CAEA,OAAAqB,EACE,IAAMxB,EAAK,MACVyB,GAAU,CACJA,IACLlB,EAAS,MAAQ,GACjBJ,EAAa,MAAQ,GACrBuB,EAAS,IAAM,CACTlB,EAAe,MAAM,KACvBH,EAAW,MAAM,GAAG,MAAO,EAE3BC,EAAQ,MAAM,GAAG,MAAO,EAE1BE,EAAe,MAAQ,CAAE,GAAGV,EAAM,aAAe,EAC7CU,EAAe,MAAM,OACvBD,EAAS,MAAQ,GAEzB,CAAK,EACF,CACH;;;;;;;;;;"}