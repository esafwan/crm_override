import{_ as $e}from"./GroupByIcon-584f979a.js";import{_ as De,a as Se,L as Ue}from"./SidePanelModal-490a8763.js";import{A as Ee,E as Ae,_ as Me,S as Re,a as Te,L as Ne}from"./SLASection-72cc8d88.js";import{E as Be}from"./EditIcon-3c54f763.js";import{E as ae}from"./Email2Icon-c181bc5b.js";import{C as qe}from"./CommentIcon-fd4d721b.js";import{P}from"./PhoneIcon-3c556b02.js";import{T as Le}from"./TaskIcon-5ecf8abe.js";import{N as je}from"./NoteModal-fe2f5600.js";import{W as Pe}from"./WhatsAppIcon-67297c1d.js";import{I as Fe}from"./IndicatorIcon-d1b8f59f.js";import{A as Oe}from"./ArrowUpRightIcon-60e3a514.js";import{S as We}from"./Fields-ea2aa0dd.js";import{_ as Ge}from"./LayoutHeader-ce3efb9b.js";import{_ as He}from"./OrganizationModal-1b108108.js";import{_ as Ke}from"./AssignmentModal-a088aaa9.js";import{s as Je,_ as Qe}from"./statuses-3dacf993.js";import{C as Xe}from"./ContactModal-cf8a9129.js";import{_ as Ye}from"./views-5c6870e6.js";import{_ as te}from"./Section-2652928e.js";import{_ as Ze}from"./CustomActions-d045e678.js";import{g as ea,u as aa,s as ta,h as oa,i as sa,j as x,k as la,_ as $,b as oe,l as R,o as na}from"./index-8340263f.js";import{g as ia,_ as ra}from"./view-eb7d1a47.js";import{o as da}from"./organizations-c51d501b.js";import{c as se,w as ma}from"./settings-6089b88c.js";import{h as ua,v as ca,x as T,a as pa,l as b,j as F,K as _a,r as O,b as d,c as p,u as t,g as f,w as i,p as _,d as o,F as W,I as D,G as fa,n as N,L as va,e as u,t as h,f as le,H as ne,B as ga}from"./index-82d0b844.js";import{_ as ya}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-cd1be04a.js";import{D as ie}from"./Dropdown-f8d4a8c8.js";import"./DragVerticalIcon-71ed262e.js";import"./Switch.vue_vue_type_script_setup_true_lang-d07933ba.js";import"./label-16764775.js";import"./CalendarIcon-5c294322.js";import"./callLog-0801e3f3.js";import"./contacts-226dfac2.js";import"./Dropdown-57634c86.js";import"./FadedScrollableDiv-5302c81a.js";import"./FileUploader-b4f98b38.js";import"./LeadsIcon-186f8b9f.js";import"./DealsIcon-491a0387.js";import"./EmailTemplateModal-77cc8111.js";import"./TaskModal-16274f1c.js";import"./NestedPopover-9b04b27b.js";import"./OrganizationsIcon-557bc8d4.js";const ba={key:1,class:"flex h-full overflow-hidden"},xa={class:"flex items-center justify-start gap-5 border-b p-5"},ha={class:"group relative size-12"},Ca={class:"flex flex-col gap-2.5 truncate"},wa={class:"truncate text-2xl font-medium"},ka={class:"flex gap-1.5"},Ia={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Va={class:"flex flex-col overflow-y-auto"},za={key:0,class:"pr-2"},$a={key:1},Da={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},Sa={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},Ua=["onClick"],Ea={class:"truncate"},Aa={class:"flex items-center"},Ma={class:"flex flex-col gap-1.5 text-base text-gray-800"},Ra={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Ta={class:"flex items-center gap-3 p-1 py-1.5"},Na={key:0,class:"mx-2 h-px border-t border-gray-200"},Ba={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},$t={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(re){const{$dialog:de,makeCall:me}=ea(),{organizations:ue,getOrganization:ce}=da(),{statusOptions:pe,getDealStatus:_e}=Je(),{isManager:fe}=aa(),C=ua(),S=ca(),v=re,s=T({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:v.dealId},cache:["deal",v.dealId],onSuccess:a=>{let e={doc:a,$dialog:de,router:S,updateField:V,createToast:x,deleteDoc:Ie,call:D};ta(a),oa(a,e),sa(a,e)}});pa(()=>{s.data||s.fetch()});const B=b(!1),q=b(!1),U=b(!1),E=b(!1),L=b({}),w=F(()=>{var a;return((a=s.data)==null?void 0:a.organization)&&ce(s.data.organization)});function ve(a,e,r){e=Array.isArray(a)?"":e,!ge(a,e)&&T({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:v.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{s.reload(),B.value=!0,x({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),r==null||r()},onError:m=>{var k;x({title:__("Error updating deal"),text:__((k=m.messages)==null?void 0:k[0]),icon:"x",iconClasses:"text-red-600"})}})}function ge(a,e){var m;let r=s.data.fields_meta||{};return(m=r[a])!=null&&m.reqd&&!e?(x({title:__("Error Updating Deal"),text:__("{0} is a required field",[r[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const ye=F(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];if(C.query.view||C.query.viewType){let r=ia(C.query.view,C.query.viewType,"CRM Deal");r&&a.push({label:__(r.label),icon:r.icon,route:{name:"Deals",params:{viewType:C.query.viewType},query:{view:C.query.view}}})}return a.push({label:((e=w.value)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:s.data.name}}}),a});_a(()=>{var a,e;return{title:((a=w.value)==null?void 0:a.name)||((e=s.data)==null?void 0:e.name)}});const A=b(0),be=F(()=>[{name:"Activity",label:__("Activity"),icon:Ee},{name:"Emails",label:__("Emails"),icon:Ae},{name:"Comments",label:__("Comments"),icon:qe},{name:"Calls",label:__("Calls"),icon:P,condition:()=>se.value},{name:"Tasks",label:__("Tasks"),icon:Le},{name:"Notes",label:__("Notes"),icon:je},{name:"WhatsApp",label:__("WhatsApp"),icon:Pe,condition:()=>ma.value}].filter(e=>e.condition?e.condition():!0)),M=T({url:"crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",v.dealId],params:{doctype:"CRM Deal",name:v.dealId},auto:!0,transform:a=>xe(a)});function xe(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(r=>{r.name=="organization"&&(r.create=(m,k)=>{L.value.organization_name=m,q.value=!0,k()},r.link=m=>S.push({name:"Organization",params:{organizationId:m}}))})}),a}const j=b(!1),G=b({});function he(a){let e=[{label:__("Remove"),icon:"trash-2",onClick:()=>Ce(a.name)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:ga(We,{class:"h-4 w-4"}),onClick:()=>we(a)}),e}async function H(a){await D("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:v.dealId,contact:a})&&(g.reload(),x({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function Ce(a){await D("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:v.dealId,contact:a})&&(g.reload(),x({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function we(a){await D("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:v.dealId,contact:a})&&(g.reload(),x({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const g=T({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:v.dealId},cache:["deal_contacts",v.dealId],auto:!0,transform:a=>(a.forEach(e=>{e.opened=!1}),a)});function ke(){var r;let a=(r=g.data)==null?void 0:r.find(m=>m.is_primary),e=a.mobile_no||null;if(!a){R(__("No primary contact set"));return}if(!e){R(__("No mobile number set"));return}me(e)}function V(a,e,r){ve(a,e,()=>{s.data[a]=e,r==null||r()})}async function Ie(a){await D("frappe.client.delete",{doctype:"CRM Deal",name:a}),S.push({name:"Deals"})}const K=b(null);function Ve(){K.value.emailBox.show=!0}return(a,e)=>{const r=O("FeatherIcon"),m=O("Button"),k=O("Badge");return d(),p(W,null,[t(s).data?(d(),f(Ge,{key:0},{"left-header":i(()=>[o(t(ya),{items:ye.value},{prefix:i(({item:l})=>[l.icon?(d(),f($e,{key:0,icon:l.icon,class:"mr-2 h-4"},null,8,["icon"])):_("",!0)]),_:1},8,["items"])]),"right-header":i(()=>{var l;return[t(s).data._customActions?(d(),f(Ze,{key:0,actions:t(s).data._customActions},null,8,["actions"])):_("",!0),(d(),f(fa(((l=t(s).data._assignedTo)==null?void 0:l.length)==1?"Button":"div"),null,{default:i(()=>[o(Qe,{avatars:t(s).data._assignedTo,onClick:e[0]||(e[0]=n=>U.value=!0)},null,8,["avatars"])]),_:1})),o(t(ie),{options:t(pe)("deal",V,t(s).data._customStatuses)},{default:i(({open:n})=>[o(m,{label:t(s).data.status,class:N(t(_e)(t(s).data.status).colorClass)},{prefix:i(()=>[o(Fe)]),suffix:i(()=>[o(r,{name:n?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):_("",!0),t(s).data?(d(),p("div",ba,[o(t(ra),{modelValue:A.value,"onUpdate:modelValue":e[4]||(e[4]=l=>A.value=l),tabs:be.value},{default:i(({tab:l})=>[o(Me,{ref_key:"activities",ref:K,doctype:"CRM Deal",title:l.name,reload:B.value,"onUpdate:reload":e[1]||(e[1]=n=>B.value=n),tabIndex:A.value,"onUpdate:tabIndex":e[2]||(e[2]=n=>A.value=n),modelValue:t(s),"onUpdate:modelValue":e[3]||(e[3]=n=>va(s)?s.value=n:null)},null,8,["title","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(De,{side:"right",class:"flex flex-col justify-between border-l"},{default:i(()=>{var l;return[u("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=n=>t(la)(t(s).data.name))},h(a.__(t(s).data.name)),1),u("div",xa,[o(t($),{text:a.__("Organization logo")},{default:i(()=>{var n,I;return[u("div",ha,[o(t(oe),{size:"3xl",class:"size-12",label:((n=w.value)==null?void 0:n.name)||a.__("Untitled"),image:(I=w.value)==null?void 0:I.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),u("div",Ca,[o(t($),{text:((l=w.value)==null?void 0:l.name)||a.__("Set an organization")},{default:i(()=>{var n;return[u("div",wa,h(((n=w.value)==null?void 0:n.name)||a.__("Untitled")),1)]}),_:1},8,["text"]),u("div",ka,[t(se)?(d(),f(t($),{key:0,text:a.__("Make a call")},{default:i(()=>[o(m,{class:"h-7 w-7",onClick:ke},{default:i(()=>[o(P,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):_("",!0),o(t($),{text:a.__("Send an email")},{default:i(()=>[o(m,{class:"h-7 w-7"},{default:i(()=>[o(ae,{class:"h-4 w-4",onClick:e[6]||(e[6]=n=>t(s).data.email?Ve():t(R)(a.__("No email set")))})]),_:1})]),_:1},8,["text"]),o(t($),{text:a.__("Go to website")},{default:i(()=>[o(m,{class:"h-7 w-7"},{default:i(()=>[o(Ue,{class:"h-4 w-4",onClick:e[7]||(e[7]=n=>t(s).data.website?t(na)(t(s).data.website):t(R)(a.__("No website set")))})]),_:1})]),_:1},8,["text"])])])]),t(s).data.sla_status?(d(),f(Re,{key:0,modelValue:t(s).data,"onUpdate:modelValue":e[8]||(e[8]=n=>t(s).data=n),onUpdateField:V},null,8,["modelValue"])):_("",!0),t(M).data?(d(),p("div",Ia,[u("div",Va,[(d(!0),p(W,null,le(t(M).data,(n,I)=>(d(),p("div",{key:n.label,class:N(["flex flex-col p-3",{"border-b":I!==t(M).data.length-1}])},[o(te,{"is-opened":n.opened,label:n.label},{actions:i(()=>[n.contacts?(d(),p("div",za,[o(Ye,{value:"",doctype:"Contact",onChange:e[9]||(e[9]=y=>H(y)),onCreate:(y,z)=>{G.value={first_name:y,company_name:t(s).data.organization},j.value=!0,z()}},{target:i(({togglePopover:y})=>[o(m,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:z=>y()},null,8,["onClick"])]),_:1},8,["onCreate"])])):(!n.contacts&&I==1||I==0)&&t(fe)()?(d(),f(m,{key:1,variant:"ghost",class:"w-7 mr-2",onClick:e[10]||(e[10]=y=>E.value=!0)},{default:i(()=>[o(Be,{class:"h-4 w-4"})]),_:1})):_("",!0)]),default:i(()=>{var y,z,J,Q,X;return[n.fields?(d(),f(Te,{key:0,fields:n.fields,modelValue:t(s).data,"onUpdate:modelValue":e[11]||(e[11]=c=>t(s).data=c),onUpdate:V},null,8,["fields","modelValue"])):(d(),p("div",$a,[(y=t(g))!=null&&y.loading&&((J=(z=t(g))==null?void 0:z.data)==null?void 0:J.length)==0?(d(),p("div",Da,[o(Ne,{class:"h-4 w-4"}),u("span",null,h(a.__("Loading...")),1)])):(X=(Q=t(g))==null?void 0:Q.data)!=null&&X.length?(d(!0),p(W,{key:1},le(t(g).data,(c,Y)=>(d(),p("div",{key:c.name},[u("div",{class:N(["px-2 pb-2.5",[Y==0?"pt-5":"pt-2.5"]])},[o(te,{"is-opened":c.opened},{header:i(({opened:ze,toggle:Z})=>[u("div",Sa,[u("div",{class:"flex h-7 items-center gap-2 truncate",onClick:ee=>Z()},[o(t(oe),{label:c.full_name,image:c.image,size:"md"},null,8,["label","image"]),u("div",Ea,h(c.full_name),1),c.is_primary?(d(),f(k,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):_("",!0)],8,Ua),u("div",Aa,[o(t(ie),{options:he(c)},{default:i(()=>[o(m,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),o(m,{variant:"ghost",onClick:ee=>t(S).push({name:"Contact",params:{contactId:c.name}})},{default:i(()=>[o(Oe,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(m,{variant:"ghost",onClick:ee=>Z()},{default:i(()=>[o(r,{name:"chevron-right",class:N(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":ze}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:i(()=>[u("div",Ma,[u("div",Ra,[o(ae,{class:"h-4 w-4"}),ne(" "+h(c.email),1)]),u("div",Ta,[o(P,{class:"h-4 w-4"}),ne(" "+h(c.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),Y!=t(g).data.length-1?(d(),p("div",Na)):_("",!0)]))),128)):(d(),p("div",Ba,h(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):_("",!0)]}),_:1})])):_("",!0),o(He,{modelValue:q.value,"onUpdate:modelValue":e[12]||(e[12]=l=>q.value=l),organization:L.value,"onUpdate:organization":e[13]||(e[13]=l=>L.value=l),options:{redirect:!1,afterInsert:l=>V("organization",l.name,()=>{t(ue).reload()})}},null,8,["modelValue","organization","options"]),o(Xe,{modelValue:j.value,"onUpdate:modelValue":e[14]||(e[14]=l=>j.value=l),contact:G.value,options:{redirect:!1,afterInsert:l=>H(l.name)}},null,8,["modelValue","contact","options"]),U.value?(d(),f(Ke,{key:2,modelValue:U.value,"onUpdate:modelValue":e[15]||(e[15]=l=>U.value=l),assignees:t(s).data._assignedTo,"onUpdate:assignees":e[16]||(e[16]=l=>t(s).data._assignedTo=l),doc:t(s).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):_("",!0),E.value?(d(),f(Se,{key:3,modelValue:E.value,"onUpdate:modelValue":e[17]||(e[17]=l=>E.value=l),doctype:"CRM Deal",onReload:e[18]||(e[18]=()=>t(M).reload())},null,8,["modelValue"])):_("",!0)],64)}}};export{$t as default};
//# sourceMappingURL=Deal-a4091f56.js.map
